{"timestamp": "2026-02-01T17:20:52.668080", "level": "CRITICAL", "name": "utils.error_handler", "message": "UNHANDLED EXCEPTION: ValueError", "request_id": "715c867b", "exc_info": "  + Exception Group Traceback (most recent call last):\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 79, in collapse_excgroups\n  |     yield\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 271, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |                ~~~~~~~~~~~~~~~~~~~~~~~^^\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 772, in __aexit__\n  |     raise BaseExceptionGroup(\n  |         \"unhandled errors in a TaskGroup\", self._exceptions\n  |     ) from None\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 189, in __call__\n    |     raise app_exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\cors.py\", line 85, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 78, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 76, in app\n    |     await response(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 270, in __call__\n    |     with collapse_excgroups():\n    |          ~~~~~~~~~~~~~~~~~~^^\n    |   File \"C:\\Users\\user\\AppData\\Roaming\\uv\\python\\cpython-3.13.5-windows-x86_64-none\\Lib\\contextlib.py\", line 162, in __exit__\n    |     self.gen.throw(value)\n    |     ~~~~~~~~~~~~~~^^^^^^^\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 274, in wrap\n    |     await func()\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 254, in stream_response\n    |     async for chunk in self.body_iterator:\n    |     ...<2 lines>...\n    |         await send({\"type\": \"http.response.body\", \"body\": chunk, \"more_body\": True})\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\api\\doctor_chat_v2.py\", line 101, in generate_with_memory\n    |     logger.info(f\"Stream duration: {total_duration:.2fs}\")\n    |                                    ^^^^^^^^^^^^^^^^^^^^^\n    | ValueError: Invalid format specifier '.2fs' for object of type 'float'\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 189, in __call__\n    raise app_exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 76, in app\n    await response(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 270, in __call__\n    with collapse_excgroups():\n         ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\user\\AppData\\Roaming\\uv\\python\\cpython-3.13.5-windows-x86_64-none\\Lib\\contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 274, in wrap\n    await func()\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 254, in stream_response\n    async for chunk in self.body_iterator:\n    ...<2 lines>...\n        await send({\"type\": \"http.response.body\", \"body\": chunk, \"more_body\": True})\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\api\\doctor_chat_v2.py\", line 101, in generate_with_memory\n    logger.info(f\"Stream duration: {total_duration:.2fs}\")\n                                   ^^^^^^^^^^^^^^^^^^^^^\nValueError: Invalid format specifier '.2fs' for object of type 'float'", "exception_type": "ValueError", "exception_message": "Invalid format specifier '.2fs' for object of type 'float'", "path": "/api/doctor/stream", "method": "POST", "traceback": "  + Exception Group Traceback (most recent call last):\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 79, in collapse_excgroups\n  |     yield\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 271, in __call__\n  |     async with anyio.create_task_group() as task_group:\n  |                ~~~~~~~~~~~~~~~~~~~~~~~^^\n  |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 772, in __aexit__\n  |     raise BaseExceptionGroup(\n  |         \"unhandled errors in a TaskGroup\", self._exceptions\n  |     ) from None\n  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)\n  +-+---------------- 1 ----------------\n    | Traceback (most recent call last):\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\errors.py\", line 164, in __call__\n    |     await self.app(scope, receive, _send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 189, in __call__\n    |     raise app_exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    |     await self.app(scope, receive_or_disconnect, send_no_error)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\cors.py\", line 85, in __call__\n    |     await self.app(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    |     await self.middleware_stack(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    |     await route.handle(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    |     await self.app(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 78, in app\n    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    |     await app(scope, receive, sender)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 76, in app\n    |     await response(scope, receive, send)\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 270, in __call__\n    |     with collapse_excgroups():\n    |          ~~~~~~~~~~~~~~~~~~^^\n    |   File \"C:\\Users\\user\\AppData\\Roaming\\uv\\python\\cpython-3.13.5-windows-x86_64-none\\Lib\\contextlib.py\", line 162, in __exit__\n    |     self.gen.throw(value)\n    |     ~~~~~~~~~~~~~~^^^^^^^\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 85, in collapse_excgroups\n    |     raise exc\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 274, in wrap\n    |     await func()\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 254, in stream_response\n    |     async for chunk in self.body_iterator:\n    |     ...<2 lines>...\n    |         await send({\"type\": \"http.response.body\", \"body\": chunk, \"more_body\": True})\n    |   File \"C:\\Users\\user\\Desktop\\metamed_backend\\api\\doctor_chat_v2.py\", line 101, in generate_with_memory\n    |     logger.info(f\"Stream duration: {total_duration:.2fs}\")\n    |                                    ^^^^^^^^^^^^^^^^^^^^^\n    | ValueError: Invalid format specifier '.2fs' for object of type 'float'\n    +------------------------------------\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\errors.py\", line 164, in __call__\n    await self.app(scope, receive, _send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 189, in __call__\n    raise app_exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\cors.py\", line 85, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 78, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\routing.py\", line 76, in app\n    await response(scope, receive, send)\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 270, in __call__\n    with collapse_excgroups():\n         ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\user\\AppData\\Roaming\\uv\\python\\cpython-3.13.5-windows-x86_64-none\\Lib\\contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\_utils.py\", line 85, in collapse_excgroups\n    raise exc\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 274, in wrap\n    await func()\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\.venv\\Lib\\site-packages\\starlette\\responses.py\", line 254, in stream_response\n    async for chunk in self.body_iterator:\n    ...<2 lines>...\n        await send({\"type\": \"http.response.body\", \"body\": chunk, \"more_body\": True})\n  File \"C:\\Users\\user\\Desktop\\metamed_backend\\api\\doctor_chat_v2.py\", line 101, in generate_with_memory\n    logger.info(f\"Stream duration: {total_duration:.2fs}\")\n                                   ^^^^^^^^^^^^^^^^^^^^^\nValueError: Invalid format specifier '.2fs' for object of type 'float'\n", "logger": "utils.error_handler", "file": "C:\\Users\\user\\Desktop\\metamed_backend\\utils\\error_handler.py", "line": 170, "function": "unhandled_exception_handler"}
